<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Min V√§lm√•ende-app</title>
    <style>
        :root {
            --bg: #f0f4f8; --card: #ffffff; --text: #334e4e;
            --accent: #2d5a27; --nav-bg: #ffffff; --input-bg: #f9f9f9;
        }
        body.dark-mode {
            --bg: #121212; --card: #1e1e1e; --text: #e0e0e0;
            --accent: #81c784; --nav-bg: #1e1e1e; --input-bg: #2a2a2a;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, sans-serif;
            background-color: var(--bg); color: var(--text);
            overflow: hidden; transition: background-color 0.4s ease, color 0.4s ease;
        }

        /* LOCK */
        #lock-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(160deg, #1a3a2a 0%, #0d1f14 100%);
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; z-index: 9999; gap: 20px;
        }
        #lock-screen.hidden { display: none; }
        .lock-icon { font-size: 3rem; animation: pulse 2s infinite ease-in-out; }
        @keyframes pulse { 0%,100%{transform:scale(1);opacity:.9;} 50%{transform:scale(1.08);opacity:1;} }
        .lock-title { color:#fff; font-size:1.4rem; font-weight:600; }
        .lock-subtitle { color:rgba(255,255,255,0.5); font-size:0.85rem; margin-top:-12px; }
        .pin-dots { display:flex; gap:16px; margin:8px 0; }
        .pin-dot { width:16px;height:16px;border-radius:50%;border:2px solid rgba(255,255,255,0.4);background:transparent;transition:background .15s,border-color .15s,transform .15s; }
        .pin-dot.filled { background:#81c784;border-color:#81c784;transform:scale(1.15); }
        .pin-dot.error { background:#e57373;border-color:#e57373;animation:shake .4s ease; }
        @keyframes shake { 0%,100%{transform:translateX(0);} 20%{transform:translateX(-6px);} 40%{transform:translateX(6px);} 60%{transform:translateX(-4px);} 80%{transform:translateX(4px);} }
        .numpad { display:grid;grid-template-columns:repeat(3,72px);gap:14px; }
        .num-btn { width:72px;height:72px;border-radius:50%;border:none;background:rgba(255,255,255,0.1);color:white;font-size:1.5rem;font-weight:500;cursor:pointer;transition:background .15s,transform .1s;display:flex;align-items:center;justify-content:center; }
        .num-btn:active { background:rgba(255,255,255,0.25);transform:scale(0.93); }
        .num-btn.empty { background:transparent;cursor:default; }
        .faceid-btn { background:none;border:1.5px solid rgba(255,255,255,0.3);color:rgba(255,255,255,0.7);padding:10px 24px;border-radius:20px;font-size:.9rem;cursor:pointer;display:flex;align-items:center;gap:8px; }
        .faceid-btn.hidden { display:none; }
        .lock-error { color:#e57373;font-size:.85rem;min-height:20px;text-align:center; }

        /* APP */
        #app { display:flex;flex-direction:column;overflow:hidden;position:fixed;top:0;left:0; }
        #content-area { overflow-y:hidden;padding:clamp(8px,2vw,14px);padding-bottom:8px; }
        h1 { font-size:clamp(1.1rem,3.5vw,1.8rem);margin-bottom:10px; }
        h3 { font-size:clamp(.95rem,2.5vw,1.2rem); }
        .tab-content { display:none; }
        .active-tab { display:flex;flex-direction:column;animation:fadeIn .5s ease; }
        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

        .card { background:var(--card);border-radius:20px;padding:clamp(8px,2vw,16px);margin-bottom:10px;box-shadow:0 8px 20px rgba(0,0,0,.05); }
        .settings-card { background:var(--card);border-radius:20px;padding:clamp(10px,2.5vw,20px);margin-bottom:12px;box-shadow:0 8px 20px rgba(0,0,0,.05);text-align:left; }
        .settings-card h3 { margin:0 0 10px;color:var(--accent); }
        .settings-row { display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(128,128,128,.15); }
        .settings-row:last-child { border-bottom:none; }
        .settings-label { font-size:clamp(.9rem,2.5vw,1.05rem); }
        .toggle { position:relative;width:50px;height:28px;flex-shrink:0; }
        .toggle input { opacity:0;width:0;height:0; }
        .slider { position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#ccc;border-radius:28px;transition:.3s; }
        .slider:before { content:"";position:absolute;width:20px;height:20px;left:4px;bottom:4px;background:white;border-radius:50%;transition:.3s; }
        input:checked+.slider { background:var(--accent); }
        input:checked+.slider:before { transform:translateX(22px); }
        .btn-row { display:flex;gap:10px;justify-content:center;margin-top:10px; }
        .action-btn { flex:1;padding:clamp(8px,2vw,14px);border-radius:15px;border:none;background:var(--accent);color:white;font-weight:bold;cursor:pointer;font-size:clamp(.85rem,2.5vw,1rem); }
        .input-row { display:flex;gap:8px;margin-top:10px; }
        .text-input { flex:1;padding:12px;border-radius:12px;border:1px solid rgba(128,128,128,.3);background:var(--input-bg);color:var(--text);font-size:clamp(.85rem,2.5vw,.95rem); }
        .text-input:focus { outline:2px solid var(--accent); }
        .add-btn { padding:12px 16px;border-radius:12px;border:none;background:var(--accent);color:white;font-weight:bold;cursor:pointer;white-space:nowrap; }
        .item-list { margin-top:10px;max-height:180px;overflow-y:auto; }
        .list-item { display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-radius:10px;margin-bottom:6px;background:var(--input-bg);font-size:clamp(.8rem,2.2vw,.9rem); }
        .del-btn { background:none;border:none;color:#e57373;cursor:pointer;font-size:1.1rem;padding:0 4px; }
        #bottom-nav { display:flex;justify-content:space-around;background:var(--nav-bg);box-shadow:0 -2px 10px rgba(0,0,0,.1);flex-shrink:0; }
        #bottom-nav button { background:none;border:none;color:#888;display:flex;flex-direction:column;align-items:center;font-size:clamp(.6rem,2vw,.75rem);cursor:pointer;padding:8px 6px;flex:1; }
        #bottom-nav button .nav-icon { font-size:clamp(1.2rem,4vw,1.5rem); }
        #bottom-nav button.active { color:var(--accent);font-weight:bold; }
        #screen-info { font-size:.72rem;color:#888;margin-top:4px;background:var(--card);padding:4px 10px;border-radius:20px;display:inline-block; }

        /* FLIK 1 */
        .new-thoughts-btn { background:linear-gradient(145deg,#3a7a32,#2d5a27);color:white;border:none;border-radius:14px;padding:10px 14px;font-size:clamp(.8rem,2vw,.9rem);font-weight:bold;cursor:pointer;white-space:nowrap;box-shadow:0 6px 0 #1a3a17,0 8px 10px rgba(0,0,0,.3);transform:translateY(0);transition:transform .1s,box-shadow .1s; }
        .new-thoughts-btn:active { transform:translateY(4px);box-shadow:0 2px 0 #1a3a17; }
        .gratitude-image { width:100%;border-radius:16px;display:block;object-fit:cover;height:clamp(110px,18vh,200px); }
        .gratitude-sentence { font-weight:bold;font-size:clamp(.9rem,2.5vw,1.05rem);padding:8px 0;display:flex;align-items:center;gap:8px; }
        .gratitude-sentence:not(:last-child) { border-bottom:1px solid rgba(0,0,0,.07); }

        /* FLIK 2 */
        #tab-calm { background:linear-gradient(135deg,#0d2137 0%,#1a3a5c 40%,#0d3320 100%);border-radius:20px;padding:clamp(10px,2vw,18px);min-height:0;flex:1; }
        #tab-calm h1 { color:#e0f0ff;text-align:center; }
        #timer-display { font-size:clamp(2rem,8vw,3.5rem);font-weight:bold;margin:6px 0;color:#7dd4fc;text-shadow:0 0 20px rgba(125,212,252,.5);text-align:center; }
        #breath-label { font-size:clamp(.95rem,3vw,1.2rem);font-weight:600;color:#a5f3fc;margin:4px 0;min-height:26px;transition:color .5s;text-align:center; }
        .breath-wrap { position:relative;margin:8px auto;width:clamp(130px,28vw,200px);height:clamp(130px,28vw,200px);display:none;align-items:center;justify-content:center; }
        .breath-wrap.show { display:flex; }
        .breath-ring { position:absolute;border-radius:50%;background:radial-gradient(circle at 35% 35%,#a5f3fc,#0369a1 60%,#012d52);box-shadow:0 0 40px rgba(125,212,252,.4),inset 0 -8px 20px rgba(0,0,0,.3),inset 0 8px 20px rgba(255,255,255,.15);width:100%;height:100%; }
        .breath-inner { position:absolute;border-radius:50%;background:radial-gradient(circle at 35% 35%,rgba(255,255,255,.3),transparent 60%);width:60%;height:60%; }
        .breath-text { position:relative;z-index:2;color:white;font-weight:bold;font-size:clamp(.75rem,2vw,.9rem);text-align:center;text-shadow:0 1px 4px rgba(0,0,0,.5);white-space:pre-line; }
        @keyframes breatheIn { from{transform:scale(0.6);box-shadow:0 0 20px rgba(125,212,252,.2),inset 0 -8px 20px rgba(0,0,0,.3);} to{transform:scale(1.0);box-shadow:0 0 60px rgba(125,212,252,.7),inset 0 -8px 20px rgba(0,0,0,.3);} }
        @keyframes breatheHold { 0%,100%{transform:scale(1.0);box-shadow:0 0 60px rgba(125,212,252,.7),inset 0 -8px 20px rgba(0,0,0,.3);} }
        @keyframes breatheOut { from{transform:scale(1.0);box-shadow:0 0 60px rgba(125,212,252,.7),inset 0 -8px 20px rgba(0,0,0,.3);} to{transform:scale(0.6);box-shadow:0 0 20px rgba(125,212,252,.2),inset 0 -8px 20px rgba(0,0,0,.3);} }
        .rain-row { display:flex;align-items:center;gap:10px;margin-top:10px;background:rgba(255,255,255,.08);border-radius:12px;padding:8px 12px; }
        .rain-label { color:#a5f3fc;font-size:.9rem;flex-shrink:0; }
        .rain-toggle-btn { background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.2);color:white;padding:4px 12px;border-radius:20px;cursor:pointer;font-size:.85rem; }
        input[type=range] { flex:1;accent-color:#7dd4fc; }

        /* FLIK 3 */
        #tab-inspire { text-align:center; }
        .pepp-card { background:linear-gradient(135deg,#1a3a2a,#2d5a27);border-radius:24px;padding:clamp(16px,3vw,30px);margin-bottom:14px;position:relative;overflow:hidden;box-shadow:0 12px 40px rgba(45,90,39,.4); }
        .pepp-card::before { content:'';position:absolute;top:-40px;right:-40px;width:150px;height:150px;border-radius:50%;background:rgba(255,255,255,.05); }
        .pepp-emoji { font-size:clamp(1.8rem,5vw,2.8rem);margin-bottom:8px;display:block; }
        #quote-text { font-style:italic;font-size:clamp(.95rem,2.8vw,1.2rem);color:#e0ffe8;font-weight:500;line-height:1.6;position:relative;z-index:1; }
        .pepp-btn { background:linear-gradient(145deg,#3a7a32,#2d5a27);color:white;border:none;border-radius:18px;padding:clamp(12px,2.5vw,16px) clamp(20px,4vw,36px);font-size:clamp(.95rem,2.5vw,1.1rem);font-weight:bold;cursor:pointer;box-shadow:0 6px 0 #1a3a17,0 10px 20px rgba(0,0,0,.2);transform:translateY(0);transition:transform .1s,box-shadow .1s;width:100%; }
        .pepp-btn:active { transform:translateY(5px);box-shadow:0 1px 0 #1a3a17; }
        .pepp-stars { display:flex;justify-content:center;gap:6px;margin:8px 0; }
        .pepp-star { font-size:1.2rem;animation:twinkle 2s infinite ease-in-out; }
        .pepp-star:nth-child(2){animation-delay:.3s;} .pepp-star:nth-child(3){animation-delay:.6s;}
        @keyframes twinkle { 0%,100%{opacity:.4;transform:scale(.9);} 50%{opacity:1;transform:scale(1.15);} }
    </style>
</head>
<body>

<div id="lock-screen">
    <div class="lock-icon">üîí</div>
    <div class="lock-title">Min V√§lm√•ende-app</div>
    <div class="lock-subtitle">Ange din PIN-kod</div>
    <div class="pin-dots">
        <div class="pin-dot" id="d0"></div><div class="pin-dot" id="d1"></div>
        <div class="pin-dot" id="d2"></div><div class="pin-dot" id="d3"></div>
        <div class="pin-dot" id="d4"></div><div class="pin-dot" id="d5"></div>
    </div>
    <div class="lock-error" id="lock-error"></div>
    <div class="numpad">
        <button class="num-btn" onclick="pinPress('1')">1</button>
        <button class="num-btn" onclick="pinPress('2')">2</button>
        <button class="num-btn" onclick="pinPress('3')">3</button>
        <button class="num-btn" onclick="pinPress('4')">4</button>
        <button class="num-btn" onclick="pinPress('5')">5</button>
        <button class="num-btn" onclick="pinPress('6')">6</button>
        <button class="num-btn" onclick="pinPress('7')">7</button>
        <button class="num-btn" onclick="pinPress('8')">8</button>
        <button class="num-btn" onclick="pinPress('9')">9</button>
        <button class="num-btn empty"></button>
        <button class="num-btn" onclick="pinPress('0')">0</button>
        <button class="num-btn" onclick="pinDelete()">‚å´</button>
    </div>
    <button class="faceid-btn hidden" id="faceid-btn" onclick="tryBiometric()">Face ID / Touch ID</button>
</div>

<div id="app">
    <div id="content-area">

        <!-- FLIK 1 -->
        <div id="tab-gratitude" class="tab-content active-tab">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
                <h1 style="margin-bottom:0;">Dagens Tacksamhet</h1>
                <button class="new-thoughts-btn" onclick="renderGratitude()">Nya tankar ‚ú®</button>
            </div>
            <div id="gratitude-container"></div>
        </div>

        <!-- FLIK 2 -->
        <div id="tab-calm" class="tab-content">
            <h1>üåä Lugn & Ro</h1>
            <div id="timer-display">00:00</div>
            <div id="breath-label">V√§lj en tid f√∂r att starta</div>
            <div class="breath-wrap" id="breath-wrap">
                <div class="breath-ring" id="breath-ring"></div>
                <div class="breath-inner"></div>
                <div class="breath-text" id="breath-text"></div>
            </div>
            <div class="rain-row">
                <span class="rain-label">üåßÔ∏è Regn</span>
                <button class="rain-toggle-btn" id="rain-btn" onclick="toggleRain()">AV</button>
                <input type="range" id="rain-vol" min="0" max="1" step="0.05" value="0.4" oninput="setRainVol(this.value)">
            </div>
            <div class="btn-row" style="margin-top:12px;">
                <button class="action-btn" onclick="startBreath(180)">3 Min</button>
                <button class="action-btn" onclick="startBreath(300)">5 Min</button>
                <button class="action-btn" style="background:#445;" onclick="stopBreath()">Stopp</button>
            </div>
        </div>

        <!-- FLIK 3 -->
        <div id="tab-inspire" class="tab-content">
            <h1>‚ú® Inspiration</h1>
            <div class="pepp-stars">
                <span class="pepp-star">‚≠ê</span>
                <span class="pepp-star">‚ú®</span>
                <span class="pepp-star">‚≠ê</span>
            </div>
            <div class="pepp-card">
                <span class="pepp-emoji" id="pepp-emoji">üíö</span>
                <p id="quote-text">Tryck p√• knappen f√∂r din dagliga dos pepp!</p>
            </div>
            <button class="pepp-btn" onclick="newQuote()">‚ö° Ge mig pepp!</button>
        </div>

        <!-- FLIK 4 -->
        <div id="tab-settings" class="tab-content">
            <h1>‚öôÔ∏è Inst√§llningar</h1>
            <div id="screen-info"></div>
            <div class="settings-card" style="margin-top:12px;">
                <h3>üé® Utseende</h3>
                <div class="settings-row">
                    <span class="settings-label">üåô Auto dark mode (19:00‚Äì07:00)</span>
                    <label class="toggle"><input type="checkbox" id="autoModeToggle" onchange="onAutoToggleChange(this.checked)"><span class="slider"></span></label>
                </div>
            </div>
            <div class="settings-card">
                <h3>üîí S√§kerhet</h3>
                <div class="settings-row">
                    <span class="settings-label">Face ID / Touch ID</span>
                    <label class="toggle"><input type="checkbox" id="biometricToggle" onchange="onBiometricToggle(this.checked)"><span class="slider"></span></label>
                </div>
            </div>
            <div class="settings-card">
                <h3>‚ô• Egna tacksamhetstexter</h3>
                <div class="input-row">
                    <input type="text" class="text-input" id="newGratitudeInput" placeholder="T.ex. Tacksam f√∂r solen..." maxlength="100">
                    <button class="add-btn" onclick="addGratitudeText()">+ L√§gg till</button>
                </div>
                <div class="item-list" id="gratitude-list"></div>
            </div>
            <div class="settings-card">
                <h3>‚ú® Egna inspirationscitat</h3>
                <div class="input-row">
                    <input type="text" class="text-input" id="newQuoteInput" placeholder="T.ex. Du √§r stark nog!" maxlength="150">
                    <button class="add-btn" onclick="addQuoteText()">+ L√§gg till</button>
                </div>
                <div class="item-list" id="quote-list"></div>
            </div>
        </div>

    </div>
    <nav id="bottom-nav">
        <button onclick="showTab('gratitude',this)" class="active"><span class="nav-icon">‚ô•</span>Tacksam</button>
        <button onclick="showTab('calm',this)"><span class="nav-icon">üßò</span>Lugn</button>
        <button onclick="showTab('inspire',this)"><span class="nav-icon">‚ú®</span>Pepp</button>
        <button onclick="showTab('settings',this)"><span class="nav-icon">‚öôÔ∏è</span>Inst√§llningar</button>
    </nav>
</div>

<script>
    // PIN
    const CORRECT_PIN = '486810';
    let pinEntry = '';
    function updateDots() { for(let i=0;i<6;i++){const d=document.getElementById('d'+i);d.classList.remove('filled','error');if(i<pinEntry.length)d.classList.add('filled');} }
    function pinPress(digit) { if(pinEntry.length>=6)return;pinEntry+=digit;updateDots();document.getElementById('lock-error').innerText='';if(pinEntry.length===6)setTimeout(checkPin,150); }
    function pinDelete() { pinEntry=pinEntry.slice(0,-1);updateDots();document.getElementById('lock-error').innerText=''; }
    function checkPin() {
        if(pinEntry===CORRECT_PIN){unlock();return;}
        for(let i=0;i<6;i++){document.getElementById('d'+i).classList.remove('filled');document.getElementById('d'+i).classList.add('error');}
        document.getElementById('lock-error').innerText='Fel PIN-kod, f√∂rs√∂k igen';
        setTimeout(()=>{for(let i=0;i<6;i++)document.getElementById('d'+i).classList.remove('error');pinEntry='';updateDots();},800);
    }
    function unlock(){document.getElementById('lock-screen').classList.add('hidden');}

    // BIOMETRICS
    async function tryBiometric(){if(!window.PublicKeyCredential){document.getElementById('lock-error').innerText='Biometri ej tillg√§nglig';return;}const credId=localStorage.getItem('biometricCredId');if(!credId){document.getElementById('lock-error').innerText='Aktivera Face ID i Inst√§llningar';return;}try{const challenge=new Uint8Array(32);crypto.getRandomValues(challenge);const a=await navigator.credentials.get({publicKey:{challenge,allowCredentials:[{id:base64ToBuffer(credId),type:'public-key',transports:['internal']}],userVerification:'required',timeout:60000}});if(a)unlock();}catch(e){document.getElementById('lock-error').innerText='Biometri misslyckades, ange PIN';}}
    async function registerBiometric(){if(!window.PublicKeyCredential){alert('Face ID st√∂ds ej');document.getElementById('biometricToggle').checked=false;return;}try{const challenge=new Uint8Array(32);crypto.getRandomValues(challenge);const userId=new Uint8Array(16);crypto.getRandomValues(userId);const cred=await navigator.credentials.create({publicKey:{challenge,rp:{name:'V√§lm√•ende-app'},user:{id:userId,name:'user',displayName:'Anv√§ndare'},pubKeyCredParams:[{type:'public-key',alg:-7}],authenticatorSelection:{authenticatorAttachment:'platform',userVerification:'required'},timeout:60000}});localStorage.setItem('biometricCredId',bufferToBase64(cred.rawId));localStorage.setItem('biometricEnabled','1');document.getElementById('faceid-btn').classList.remove('hidden');alert('Face ID aktiverat! ‚úÖ');}catch(e){alert('Kunde inte aktivera: '+e.message);document.getElementById('biometricToggle').checked=false;}}
    function onBiometricToggle(on){if(on){registerBiometric();}else{localStorage.setItem('biometricEnabled','0');localStorage.removeItem('biometricCredId');document.getElementById('faceid-btn').classList.add('hidden');}}
    function bufferToBase64(b){return btoa(String.fromCharCode(...new Uint8Array(b)));}
    function base64ToBuffer(s){const bin=atob(s);const buf=new Uint8Array(bin.length);for(let i=0;i<bin.length;i++)buf[i]=bin.charCodeAt(i);return buf.buffer;}

    // STORLEK
    function resizeApp(){const app=document.getElementById('app');const nav=document.getElementById('bottom-nav');const ca=document.getElementById('content-area');const W=window.innerWidth,H=window.innerHeight;app.style.width=W+'px';app.style.height=H+'px';ca.style.height=(H-nav.offsetHeight)+'px';}
    resizeApp();window.addEventListener('resize',resizeApp);window.addEventListener('orientationchange',()=>setTimeout(resizeApp,300));

    // DATA
    const defaultGratitudeList=["Tacksam f√∂r kaffet.","Tacksam f√∂r vilan.","Tacksam f√∂r v√§nner.","Tacksam f√∂r musiken.","Tacksam f√∂r h√§lsan.","Tacksam f√∂r Anton min son.","Tacksam f√∂r ett varmt hem.","Tacksam f√∂r det man har.","Jag har h√§lsa.","Jag har v√§nner.","Jag bor bra.","Anton min son.","Pappa.","Anna.","Att f√• √§ta gott.","Tid utan m√•sten.","En god kopp te.","Tacksam f√∂r det jag har.","Att kunna s√§ga nej. och det √§r ok","Att kunna s√§ga tack.","Stunder av lugn.","Naturen runt mig.","Gemenskap och n√§rhet."];
    const defaultQuoteList=["Du klarar detta!","Varje dag √§r ett nytt b√∂rjande.","Du √§r starkare √§n du tror.","Ta ett andetag ‚Äì du g√∂r ditt b√§sta.","Framsteg, inte perfektion.","Jag g√∂r s√• gott jag kan ‚Äì och det r√§cker f√∂r idag.","Jag √§r v√§rd respekt fr√•n andra och fr√•n mig sj√§lv.","Jag till√•ter mig sj√§lv att vila, √§ven om jag inte 'f√∂rtj√§nat' det.","Jag l√§r mig och utvecklas varje dag.","Varje dag tar jag steg mot mitt b√§sta jag.","Jag √§r kapabel att hantera utmaningar.","Jag √§r mer √§n tillr√§cklig, och jag har allt jag beh√∂ver inom mig.","Jag accepterar och √§lskar mig sj√§lv precis som jag √§r.","Mina k√§nslor √§r ok, √§ven de tr√∂tta och irriterade.","Jag √§r t√•lmodig mot min egen utveckling.","Jag ser mina styrkor och v√§xer varje dag.","Jag till√•ter gl√§dje och sj√§lvk√§rlek."];
    function loadList(key,fallback){const s=localStorage.getItem(key);return s?JSON.parse(s):[...fallback];}
    function saveList(key,arr){localStorage.setItem(key,JSON.stringify(arr));}
    let myGratitudeList=loadList('gratitudeList',defaultGratitudeList);
    let myQuoteList=loadList('quoteList',defaultQuoteList);

    // DARK MODE
    function isNightTime(){const h=new Date().getHours();return h>=19||h<7;}
    function applyDarkMode(on){document.body.classList.toggle('dark-mode',on);}
    function onAutoToggleChange(on){localStorage.setItem('autoMode',on?'1':'0');applyDarkMode(on?isNightTime():false);}
    setInterval(()=>{if(localStorage.getItem('autoMode')==='1')applyDarkMode(isNightTime());},60000);

    // INIT
    (function init(){
        const autoOn=localStorage.getItem('autoMode')==='1';
        document.getElementById('autoModeToggle').checked=autoOn;
        if(autoOn)applyDarkMode(isNightTime());
        const bioEnabled=localStorage.getItem('biometricEnabled')==='1';
        document.getElementById('biometricToggle').checked=bioEnabled;
        if(bioEnabled){document.getElementById('faceid-btn').classList.remove('hidden');setTimeout(tryBiometric,400);}
    })();

    function updateScreenInfo(){const w=window.innerWidth,h=window.innerHeight;const device=w>=1024?'üñ•Ô∏è Dator':w>=768?'üì± iPad':'üì± Mobil';const el=document.getElementById('screen-info');if(el)el.innerText=device+' ¬∑ '+w+'x'+h+'px';}
    window.addEventListener('resize',updateScreenInfo);

    // NAVIGATION
    function showTab(tabName,btn){document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active-tab'));document.querySelectorAll('#bottom-nav button').forEach(b=>b.classList.remove('active'));document.getElementById('tab-'+tabName).classList.add('active-tab');btn.classList.add('active');if(tabName!=='calm')stopBreath();if(tabName==='settings'){renderSettingsLists();updateScreenInfo();}}

    // FLIK 1
    const natureIDs=[10,11,12,13,14,16,17,18,19,20,21,22,23,24,25,26,27,29,30,31];
    function renderGratitude(){
        const c=document.getElementById('gratitude-container');c.innerHTML='';
        const shuffledIDs=[...natureIDs].sort(()=>0.5-Math.random());
        const shuffledTexts=[...myGratitudeList].sort(()=>0.5-Math.random()).slice(0,3);
        const colors=['#111111','#1a3a6b','#1a5c2a'];
        const emojis=['üåø','üíô','üå±'];
        const imgWrap=document.createElement('div');imgWrap.style.cssText='margin-bottom:10px;border-radius:16px;overflow:hidden;';
        const img=document.createElement('img');img.src='https://picsum.photos/id/'+shuffledIDs[0]+'/800/400';img.className='gratitude-image';img.onerror=function(){this.style.display='none';};
        imgWrap.appendChild(img);c.appendChild(imgWrap);
        const textCard=document.createElement('div');textCard.className='card';textCard.style.textAlign='left';
        shuffledTexts.forEach((text,i)=>{const p=document.createElement('p');p.className='gratitude-sentence';p.style.color=colors[i];p.innerHTML='<span>'+emojis[i]+'</span> '+text;textCard.appendChild(p);});
        c.appendChild(textCard);
    }

    // FLIK 2
    let timerInterval,breathInterval;
    function startBreath(seconds){
        stopBreath();
        document.getElementById('breath-wrap').classList.add('show');
        let timeLeft=seconds;updateTimerDisplay(timeLeft);
        runBreathCycle();
        breathInterval=setInterval(runBreathCycle,12000);
        timerInterval=setInterval(()=>{timeLeft--;updateTimerDisplay(timeLeft);if(timeLeft<=0){stopBreath();alert('Bra jobbat! üåø Du har gett dig lugn.');}},1000);
    }
    function runBreathCycle(){animateBreath('in');setTimeout(()=>animateBreath('hold'),4000);setTimeout(()=>animateBreath('out'),8000);}
    function animateBreath(phase){
        const ring=document.getElementById('breath-ring');const label=document.getElementById('breath-label');const text=document.getElementById('breath-text');
        ring.style.animation='none';void ring.offsetWidth;
        if(phase==='in'){label.innerText='üå¨Ô∏è Andas in...';label.style.color='#a5f3fc';text.innerText='In\n4s';ring.style.animation='breatheIn 4s ease-in-out forwards';}
        else if(phase==='hold'){label.innerText='‚è∏Ô∏è H√•ll andan...';label.style.color='#fde68a';text.innerText='H√•ll\n4s';ring.style.animation='breatheHold 4s ease-in-out forwards';}
        else{label.innerText='üí® Andas ut...';label.style.color='#bbf7d0';text.innerText='Ut\n4s';ring.style.animation='breatheOut 4s ease-in-out forwards';}
    }
    function stopBreath(){clearInterval(timerInterval);clearInterval(breathInterval);document.getElementById('timer-display').innerText='00:00';document.getElementById('breath-label').innerText='V√§lj en tid f√∂r att starta';document.getElementById('breath-text').innerText='';document.getElementById('breath-wrap').classList.remove('show');document.getElementById('breath-ring').style.animation='none';stopRain();}
    function updateTimerDisplay(s){const m=Math.floor(s/60),sec=s%60;document.getElementById('timer-display').innerText=String(m).padStart(2,'0')+':'+String(sec).padStart(2,'0');}

    // REGN
    let rainCtx,rainOn=false;
    function createRain(){if(rainCtx)return;const AC=window.AudioContext||window.webkitAudioContext;if(!AC)return;rainCtx=new AC();const buf=rainCtx.createBuffer(1,rainCtx.sampleRate*2,rainCtx.sampleRate);const data=buf.getChannelData(0);for(let i=0;i<data.length;i++)data[i]=Math.random()*2-1;const src=rainCtx.createBufferSource();src.buffer=buf;src.loop=true;const filter=rainCtx.createBiquadFilter();filter.type='bandpass';filter.frequency.value=1000;filter.Q.value=0.3;window._rainGain=rainCtx.createGain();window._rainGain.gain.value=parseFloat(document.getElementById('rain-vol').value);src.connect(filter);filter.connect(window._rainGain);window._rainGain.connect(rainCtx.destination);src.start();window._rainSrc=src;}
    function toggleRain(){const btn=document.getElementById('rain-btn');if(!rainOn){createRain();if(rainCtx&&rainCtx.state==='suspended')rainCtx.resume();if(window._rainGain)window._rainGain.gain.value=parseFloat(document.getElementById('rain-vol').value);btn.innerText='P√Ö üåßÔ∏è';btn.style.background='rgba(125,212,252,0.3)';rainOn=true;}else{stopRain();}}
    function stopRain(){if(window._rainGain)window._rainGain.gain.value=0;document.getElementById('rain-btn').innerText='AV';document.getElementById('rain-btn').style.background='rgba(255,255,255,0.15)';rainOn=false;}
    function setRainVol(v){if(window._rainGain)window._rainGain.gain.value=parseFloat(v);}

    // FLIK 3
    const peppEmojis=['üíö','‚≠ê','üå±','‚ú®','üí™','üåü','üî•','üåà','üíé','ü¶ã'];
    function newQuote(){document.getElementById('quote-text').innerText=myQuoteList[Math.floor(Math.random()*myQuoteList.length)];document.getElementById('pepp-emoji').innerText=peppEmojis[Math.floor(Math.random()*peppEmojis.length)];}

    // INST√ÑLLNINGAR
    function renderSettingsLists(){renderItemList('gratitude-list',myGratitudeList,removeGratitudeText);renderItemList('quote-list',myQuoteList,removeQuoteText);}
    function renderItemList(id,arr,fn){const el=document.getElementById(id);el.innerHTML='';arr.forEach((text,i)=>{const div=document.createElement('div');div.className='list-item';div.innerHTML='<span>'+text+'</span><button class="del-btn" onclick="'+fn.name+'('+i+')">‚úï</button>';el.appendChild(div);});}
    function addGratitudeText(){const input=document.getElementById('newGratitudeInput');const val=input.value.trim();if(!val)return;myGratitudeList.push(val);saveList('gratitudeList',myGratitudeList);input.value='';renderSettingsLists();}
    function removeGratitudeText(i){myGratitudeList.splice(i,1);saveList('gratitudeList',myGratitudeList);renderSettingsLists();}
    function addQuoteText(){const input=document.getElementById('newQuoteInput');const val=input.value.trim();if(!val)return;myQuoteList.push(val);saveList('quoteList',myQuoteList);input.value='';renderSettingsLists();}
    function removeQuoteText(i){myQuoteList.splice(i,1);saveList('quoteList',myQuoteList);renderSettingsLists();}

    renderGratitude();
    newQuote();
</script>
</body>
</html>
